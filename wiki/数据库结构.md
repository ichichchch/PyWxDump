# 数据库结构

本文档介绍微信数据库的结构和主要表。

## 数据库文件

微信数据库位于用户文件夹的 `MSG` 目录下。

### 主要数据库

| 数据库 | 说明 |
|--------|------|
| `MicroMsg.db` | 联系人、群组、标签等信息 |
| `MSG0.db` - `MSG5.db` | 聊天记录（按时间分片） |
| `MediaMSG0.db` - `MediaMSG5.db` | 媒体消息 |
| `Emotion.db` | 表情包 |
| `Favorite.db` | 收藏内容 |
| `PublicMsg.db` | 公众号消息 |
| `Sns.db` | 朋友圈 |
| `FTSContact.db` | 联系人全文搜索索引 |
| `FTSMSG.db` | 消息全文搜索索引 |

### 数据库路径

```
C:\Users\xxx\Documents\WeChat Files\wxid_xxx\
├── MSG\
│   ├── MicroMsg.db
│   ├── FTSContact.db
│   ├── FTSMSG.db
│   └── Multi\
│       ├── MSG0.db
│       ├── MSG1.db
│       ├── MediaMSG0.db
│       └── ...
├── Emotion\
│   └── Emotion.db
├── Favorite\
│   └── Favorite.db
└── Sns\
    └── Sns.db
```

---

## MicroMsg.db - 联系人数据库

### Contact 表 - 联系人

| 字段 | 类型 | 说明 |
|------|------|------|
| `UserName` | TEXT | 用户名（wxid 或群ID） |
| `Alias` | TEXT | 微信号 |
| `NickName` | TEXT | 昵称 |
| `Remark` | TEXT | 备注名 |
| `Type` | INTEGER | 联系人类型 |
| `LabelIDList` | TEXT | 标签ID列表 |
| `VerifyFlag` | INTEGER | 验证标志 |
| `HeadImgUrl` | TEXT | 头像URL |

**Type 类型说明：**

| 值 | 说明 |
|----|------|
| 1 | 好友 |
| 2 | 群聊 |
| 3 | 公众号 |
| 4 | 企业号 |

### ChatRoom 表 - 群聊

| 字段 | 类型 | 说明 |
|------|------|------|
| `ChatRoomName` | TEXT | 群ID |
| `UserNameList` | TEXT | 成员列表（分号分隔） |
| `DisplayNameList` | TEXT | 显示名称列表 |
| `Owner` | TEXT | 群主 |
| `Announcement` | TEXT | 群公告 |

### ContactLabel 表 - 标签

| 字段 | 类型 | 说明 |
|------|------|------|
| `LabelId` | INTEGER | 标签ID |
| `LabelName` | TEXT | 标签名称 |

---

## MSG.db - 聊天记录数据库

### MSG 表 - 消息

| 字段 | 类型 | 说明 |
|------|------|------|
| `localId` | INTEGER | 本地消息ID |
| `MsgSvrID` | INTEGER | 服务器消息ID |
| `Type` | INTEGER | 消息类型 |
| `SubType` | INTEGER | 消息子类型 |
| `IsSender` | INTEGER | 是否发送者（1=是） |
| `CreateTime` | INTEGER | 创建时间戳 |
| `TalkerId` | INTEGER | 会话ID |
| `StrTalker` | TEXT | 会话标识（wxid或群ID） |
| `StrContent` | TEXT | 消息内容 |
| `BytesExtra` | BLOB | 额外信息（二进制） |
| `CompressContent` | BLOB | 压缩内容 |

### 消息类型 (Type)

| 值 | 说明 |
|----|------|
| 1 | 文本消息 |
| 3 | 图片消息 |
| 34 | 语音消息 |
| 42 | 名片 |
| 43 | 视频消息 |
| 47 | 动画表情 |
| 48 | 位置 |
| 49 | 链接/文件/小程序等 |
| 10000 | 系统消息 |
| 10002 | 撤回消息 |

### 子类型 (SubType) - Type=49 时

| 值 | 说明 |
|----|------|
| 1 | 文本链接 |
| 3 | 音乐 |
| 4 | 视频号视频 |
| 5 | 链接 |
| 6 | 文件 |
| 19 | 合并转发 |
| 33 | 小程序 |
| 36 | 小程序 |
| 57 | 引用消息 |
| 87 | 群公告 |

---

## MediaMSG.db - 媒体数据库

### Media 表 - 媒体文件

| 字段 | 类型 | 说明 |
|------|------|------|
| `Key` | TEXT | 媒体键 |
| `Reserved0` | INTEGER | 消息服务器ID |
| `Buf` | BLOB | 媒体数据 |

---

## Favorite.db - 收藏数据库

### FavItems 表 - 收藏项

| 字段 | 类型 | 说明 |
|------|------|------|
| `FavLocalID` | INTEGER | 本地ID |
| `Type` | INTEGER | 收藏类型 |
| `FromUser` | TEXT | 来源用户 |
| `RealChatName` | TEXT | 真实会话名 |
| `SourceTime` | INTEGER | 来源时间 |
| `UpdateTime` | INTEGER | 更新时间 |
| `Xml` | TEXT | XML内容 |

---

## PublicMsg.db - 公众号消息

### PublicMsg 表

| 字段 | 类型 | 说明 |
|------|------|------|
| `MsgSvrID` | INTEGER | 消息服务器ID |
| `AppMsgId` | INTEGER | 公众号消息ID |
| `TalkerId` | INTEGER | 公众号ID |
| `Type` | INTEGER | 消息类型 |
| `CreateTime` | INTEGER | 创建时间 |
| `Content` | TEXT | 内容 |
| `Xml` | TEXT | XML详细信息 |

---

## Sns.db - 朋友圈数据库

### SnsInfo 表 - 朋友圈动态

| 字段 | 类型 | 说明 |
|------|------|------|
| `FeedId` | TEXT | 动态ID |
| `CreateTime` | INTEGER | 创建时间 |
| `UserName` | TEXT | 发布者 |
| `Content` | BLOB | 内容（protobuf） |
| `Xml` | TEXT | XML内容 |

---

## 数据库关系图

```
┌──────────────┐     ┌──────────────┐
│  MicroMsg.db │     │    MSG.db    │
├──────────────┤     ├──────────────┤
│   Contact    │◄────│     MSG      │
│   ChatRoom   │     │   (StrTalker)│
│ ContactLabel │     └──────┬───────┘
└──────────────┘            │
                            ▼
                   ┌──────────────┐
                   │ MediaMSG.db  │
                   ├──────────────┤
                   │    Media     │
                   │  (MsgSvrID)  │
                   └──────────────┘
```

---

## 查询示例

### 获取所有好友

```sql
SELECT UserName, NickName, Remark, Alias
FROM Contact 
WHERE Type = 1;
```

### 获取聊天记录

```sql
SELECT localId, CreateTime, IsSender, StrContent, Type
FROM MSG
WHERE StrTalker = 'wxid_xxx'
ORDER BY CreateTime DESC
LIMIT 100;
```

### 获取群成员

```sql
SELECT ChatRoomName, UserNameList, DisplayNameList
FROM ChatRoom
WHERE ChatRoomName = 'xxx@chatroom';
```

### 关联查询消息和联系人

```sql
SELECT m.CreateTime, m.StrContent, c.NickName, c.Remark
FROM MSG m
LEFT JOIN Contact c ON m.StrTalker = c.UserName
WHERE m.Type = 1
ORDER BY m.CreateTime DESC;
```

---

## 注意事项

1. **数据库加密**：原始数据库是加密的，需要先解密才能查询
2. **时间戳**：`CreateTime` 是 Unix 时间戳（秒）
3. **二进制数据**：`BytesExtra` 等字段包含 protobuf 格式数据
4. **分片存储**：MSG0-MSG5 按时间分片，MSG0 最旧，MSG5 最新
5. **合并查询**：如需查询所有消息，建议先用 `merge` 命令合并数据库

---

[返回首页](Home.md) | [上一步：项目架构](项目架构.md) | [下一步：常见问题](常见问题.md)
