# 项目架构

本文档介绍 PyWxDump 的项目结构和设计。

## 目录结构

```
pywxdump/
├── __init__.py          # 包初始化，导出公共 API
├── cli.py               # 命令行接口
├── WX_OFFS.json         # 微信版本偏移配置
├── analyzer/            # 数据分析模块
├── api/                 # Web API 模块
├── db/                  # 数据库处理模块
├── ui/                  # Web 界面模块
└── wx_core/             # 核心功能模块
```

## 模块说明

### wx_core - 核心模块

负责微信信息获取、数据库解密等核心功能。

```
wx_core/
├── __init__.py          # 模块导出
├── wx_info.py           # 获取微信信息
├── decryption.py        # 数据库解密
├── get_bias_addr.py     # 获取基址偏移
├── merge_db.py          # 数据库合并
├── memory_search.py     # 内存搜索
└── utils/               # 工具函数
    ├── common_utils.py  # 通用工具
    ├── ctypes_utils.py  # ctypes 工具
    └── memory_search.py # 内存搜索工具
```

**核心功能：**

| 文件 | 功能 |
|------|------|
| `wx_info.py` | 从微信进程内存读取账号信息和密钥 |
| `decryption.py` | AES-CBC 解密微信 SQLite 数据库 |
| `get_bias_addr.py` | 获取不同版本微信的内存偏移地址 |
| `merge_db.py` | 合并多个 SQLite 数据库文件 |

### db - 数据库模块

提供统一的数据库查询接口。

```
db/
├── __init__.py          # DBHandler 组合类
├── dbbase.py            # 基础数据库类
├── dbMSG.py             # 聊天消息处理
├── dbMicro.py           # 联系人处理
├── dbMedia.py           # 媒体文件处理
├── dbFavorite.py        # 收藏处理
├── dbPublicMsg.py       # 公众号消息
├── dbOpenIMContact.py   # 企业微信联系人
├── dbOpenIMMedia.py     # 企业微信媒体
├── dbSns.py             # 朋友圈
└── utils/               # 工具函数
```

**类继承关系：**

```
DBHandler
├── MicroHandler      # 联系人
├── MediaHandler      # 媒体
├── OpenIMContactHandler  # 企业微信
├── PublicMsgHandler  # 公众号
├── OpenIMMediaHandler
├── FavoriteHandler   # 收藏
└── SnsHandler        # 朋友圈
```

### api - Web API 模块

提供 REST API 和 Web 服务。

```
api/
├── __init__.py          # FastAPI 应用和服务器启动
├── local_server.py      # 本地 API 路由
├── remote_server.py     # 远程 API 路由
├── rjson.py             # JSON 响应封装
├── utils.py             # API 工具函数
└── export/              # 数据导出
    ├── exportCSV.py     # CSV 导出
    ├── exportHtml.py    # HTML 导出
    └── exportJSON.py    # JSON 导出
```

**API 路由：**

| 前缀 | 模块 | 说明 |
|------|------|------|
| `/api/ls` | local_server | 本地 API |
| `/api/rs` | remote_server | 远程 API |

### analyzer - 分析模块

数据分析和清理功能。

```
analyzer/
├── __init__.py
├── chat_analysis.py     # 聊天分析
├── cleanup.py           # 数据清理
└── utils.py             # 分析工具
```

### ui - 界面模块

Web 前端界面文件。

```
ui/
├── __init__.py
└── web/                 # Vue.js 构建的前端文件
```

---

## 核心流程

### 1. 获取微信信息流程

```
┌─────────────────┐
│  枚举 WeChat.exe │
│     进程        │
└────────┬────────┘
         ▼
┌─────────────────┐
│  读取进程内存   │
│  WeChatWin.dll  │
└────────┬────────┘
         ▼
┌─────────────────┐
│ 根据版本偏移获取│
│ 账号、密钥等信息│
└────────┬────────┘
         ▼
┌─────────────────┐
│  返回信息字典   │
└─────────────────┘
```

### 2. 数据库解密流程

```
┌─────────────────┐
│  读取加密数据库 │
└────────┬────────┘
         ▼
┌─────────────────┐
│ 提取盐值(前16字节)│
└────────┬────────┘
         ▼
┌─────────────────┐
│  PBKDF2 派生密钥 │
│  (SHA1, 64000次) │
└────────┬────────┘
         ▼
┌─────────────────┐
│  HMAC-SHA1 验证 │
└────────┬────────┘
         ▼
┌─────────────────┐
│ AES-CBC 逐页解密│
│  (每页 4096 字节)│
└────────┬────────┘
         ▼
┌─────────────────┐
│ 写入 SQLite 文件│
└─────────────────┘
```

### 3. Web 服务架构

```
┌─────────────────────────────────────────┐
│              FastAPI App                 │
├──────────────┬──────────────┬───────────┤
│   /api/ls    │   /api/rs    │    /s     │
│  本地 API    │  远程 API    │  静态文件  │
├──────────────┴──────────────┴───────────┤
│              Uvicorn ASGI                │
└─────────────────────────────────────────┘
```

---

## 加密原理

微信数据库采用 **256位 AES-CBC** 加密：

| 组件 | 说明 |
|------|------|
| 页大小 | 4096 字节 (4KB) |
| 盐值 | 文件开头 16 字节 |
| IV | 每页末尾 16 字节 |
| HMAC | SHA1，每页末尾 20 字节 |
| 填充 | 每页末尾 12 字节空字节 |

**页结构：**

```
第一页：
[盐值 16B][数据 4032B][IV 16B][HMAC 20B][填充 12B]

后续页：
[数据 4048B][IV 16B][HMAC 20B][填充 12B]
```

---

## 版本偏移配置

`WX_OFFS.json` 存储不同微信版本的内存偏移地址：

```json
{
    "3.9.8.25": [偏移1, 偏移2, 偏移3, 偏移4, 偏移5],
    ...
}
```

偏移含义：
1. 昵称地址偏移
2. 账号地址偏移
3. 手机号地址偏移
4. 邮箱地址偏移
5. 密钥地址偏移

---

## 技术栈

| 类别 | 技术 |
|------|------|
| 语言 | Python 3.8+ |
| Web 框架 | FastAPI |
| ASGI 服务器 | Uvicorn |
| 数据库 | SQLite |
| 加密 | pycryptodomex |
| 进程操作 | ctypes, psutil |
| 前端 | Vue.js + Element UI |

---

[返回首页](Home.md) | [上一步：Python API](Python-API.md) | [下一步：数据库结构](数据库结构.md)
